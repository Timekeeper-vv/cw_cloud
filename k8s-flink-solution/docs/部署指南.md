# K8s + Docker + Flink 高速滤波部署指南

## 一、方案概述

本方案将盛老师的滤波微服务（Kalman/RLS/LS）与 Flink 流处理引擎结合，通过 K8s 实现容器编排和自动扩缩容。

### 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        K8s 集群                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────────────┐  │
│  │  Kafka   │───▶│ Flink/Python │───▶│ 盛老师滤波微服务      │  │
│  │ 数据源   │    │  流处理引擎   │    │ Kalman/RLS/LS        │  │
│  └──────────┘    └──────────────┘    │ 49.235.44.231:8000-2 │  │
│       │                │              └──────────────────────┘  │
│       │                │                       │                │
│       ▼                ▼                       ▼                │
│  sample-input    Filter Workers          filtered_signal        │
│                  (Pod x N, HPA)                │                │
│                        │                       │                │
│                        ▼                       │                │
│                  sample-output ◀───────────────┘                │
│                        │                                        │
│                        ▼                                        │
│                  ┌──────────┐                                   │
│                  │WebSocket │───▶ 前端实时显示                   │
│                  │ Bridge   │                                   │
│                  └──────────┘                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 滤波服务 API

| 算法 | 地址 | 端口 |
|------|------|------|
| Kalman | http://49.235.44.231:8000 | 8000 |
| RLS | http://49.235.44.231:8001 | 8001 |
| LS | http://49.235.44.231:8002 | 8002 |

## 二、快速开始

### 方式1: 直接使用远程滤波服务（推荐）

最简单的方式，直接在现有服务器上运行：

```bash
cd /opt/cw-cloud/CW_Cloud

# 安装依赖
pip3 install aiohttp

# 启动远程滤波服务（使用 Kalman 算法）
nohup python3 services/remote-filter-service.py --algorithm kalman > logs/remote-filter.log 2>&1 &

# 或使用 RLS 算法
nohup python3 services/remote-filter-service.py --algorithm rls > logs/remote-filter.log 2>&1 &

# 或使用 LS 算法
nohup python3 services/remote-filter-service.py --algorithm ls > logs/remote-filter.log 2>&1 &
```

### 方式2: Docker Compose 本地测试

```bash
cd k8s-flink-solution

# 启动所有服务
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f filter-gateway
```

### 方式3: K8s 集群部署

```bash
cd k8s-flink-solution/scripts

# 部署到 K8s
./deploy-k8s.sh

# 查看 Pod 状态
kubectl get pods -n signal-processing

# 查看 HPA 状态
kubectl get hpa -n signal-processing
```

## 三、性能对比

| 方案 | 处理速度 | 延迟 | 扩展性 |
|------|----------|------|--------|
| 本地 LMS | 2M/s | <10ms | 单机 |
| 远程 Kalman | 500K/s | 50-100ms | 依赖网络 |
| K8s + Flink | 10M+/s | 20-50ms | 自动扩缩容 |

## 四、配置说明

### 环境变量

| 变量 | 默认值 | 说明 |
|------|--------|------|
| KAFKA_BROKERS | localhost:9092 | Kafka 地址 |
| INPUT_TOPIC | sample-input | 输入主题 |
| OUTPUT_TOPIC | sample-output | 输出主题 |
| FILTER_ALGORITHM | kalman | 滤波算法 |
| KALMAN_SERVICE_URL | http://49.235.44.231:8000 | Kalman 服务地址 |
| RLS_SERVICE_URL | http://49.235.44.231:8001 | RLS 服务地址 |
| LS_SERVICE_URL | http://49.235.44.231:8002 | LS 服务地址 |

### K8s HPA 配置

```yaml
# 自动扩缩容配置
minReplicas: 2
maxReplicas: 20
targetCPUUtilization: 60%
```

## 五、监控和运维

### 查看服务状态

```bash
# K8s
kubectl get pods -n signal-processing
kubectl top pods -n signal-processing

# Docker Compose
docker-compose ps
docker stats
```

### 查看日志

```bash
# K8s
kubectl logs -f deployment/filter-kafka-processor -n signal-processing

# Docker Compose
docker-compose logs -f filter-kafka-processor

# 本地
tail -f /opt/cw-cloud/CW_Cloud/logs/remote-filter.log
```

### 扩缩容

```bash
# 手动扩容
kubectl scale deployment filter-kafka-processor --replicas=10 -n signal-processing

# 查看 HPA 状态
kubectl get hpa -n signal-processing
```

## 六、故障排查

### 1. 滤波服务连接失败

```bash
# 测试滤波服务连通性
curl -X POST http://49.235.44.231:8000/kalman/audio/run \
  -H "Content-Type: application/json" \
  -d '{"signal": [0.2, 0.9, -0.8, 0.7, -0.6]}'
```

### 2. Kafka 连接问题

```bash
# 检查 Kafka 状态
/opt/kafka/current/bin/kafka-topics.sh --list --bootstrap-server localhost:9092

# 检查消费者组
/opt/kafka/current/bin/kafka-consumer-groups.sh --list --bootstrap-server localhost:9092
```

### 3. 性能问题

- 增加 Worker 数量
- 调整批量大小
- 检查网络延迟
