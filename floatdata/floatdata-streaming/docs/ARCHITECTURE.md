# 系统架构详解

## 1. 整体系统架构

### 1.1 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (Application)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 采集客户端    │  │ 监控告警      │  │ 数据可视化    │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
         │                    │                    │
┌─────────────────────────────────────────────────────────────┐
│                    业务处理层 (Processing)                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Spark Streaming (流处理)                             │   │
│  │  - 时间窗口分段                                       │   │
│  │  - 数据聚合                                           │   │
│  │  - 并行处理                                           │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  异常检测处理器 (Multi-Process)                       │   │
│  │  - Butterworth 滤波                                  │   │
│  │  - FFT 频域分析                                       │   │
│  │  - 阈值判断                                           │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
         │                    │                    │
┌─────────────────────────────────────────────────────────────┐
│                    传输层 (Transport)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ Netty Server │  │ Kafka Broker │  │ 结果队列      │       │
│  │ (TCP/IP)     │  │ (消息队列)    │  │ (Kafka)      │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
         │                    │                    │
┌─────────────────────────────────────────────────────────────┐
│                    数据层 (Data)                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 采集设备      │  │ 数据库        │  │ 文件系统      │       │
│  │ (样机)        │  │ (MySQL)      │  │ (HDFS)       │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 组件交互图

```
┌─────────────────┐
│  样机采集端      │
│  (Netty Client) │
└────────┬────────┘
         │ TCP 二进制协议
         │ [timestamp|sensorId|sampleRate|location|samples]
         ▼
┌─────────────────────────────────────────┐
│  Netty Server (接收 & 缓冲)              │
│  ┌─────────────────────────────────────┐│
│  │ SignalHandler                       ││
│  │ - 解析二进制数据                     ││
│  │ - 创建 SignalData 对象               ││
│  │ - 转发到 Kafka                       ││
│  └─────────────────────────────────────┘│
└────────┬────────────────────────────────┘
         │ JSON 消息
         │ {"timestamp":..., "sensorId":..., "samples":[...]}
         ▼
┌─────────────────────────────────────────┐
│  Kafka Broker (消息队列)                 │
│  ┌─────────────────────────────────────┐│
│  │ Topic: acoustic-emission-signal     ││
│  │ Partitions: 4                       ││
│  │ Replication Factor: 1               ││
│  └─────────────────────────────────────┘│
└────────┬────────────────────────────────┘
         │ 消息流
         ▼
┌─────────────────────────────────────────┐
│  Spark Streaming (流处理)                │
│  ┌─────────────────────────────────────┐│
│  │ StreamProcessor                     ││
│  │ - 消费 Kafka 消息                    ││
│  │ - 时间窗口分段                       ││
│  │ - 分布式处理                         ││
│  └─────────────────────────────────────┘│
└────────┬────────────────────────────────┘
         │ 分段数据
         ▼
┌─────────────────────────────────────────┐
│  异常检测处理器 (多进程)                  │
│  ┌─────────────────────────────────────┐│
│  │ AnomalyDetector (Process 1)         ││
│  │ - SignalFilter (Butterworth)        ││
│  │ - 计算能量                           ││
│  │ - FFT 频域分析                       ││
│  │ - 异常判断                           ││
│  └─────────────────────────────────────┘│
│  ┌─────────────────────────────────────┐│
│  │ AnomalyDetector (Process 2)         ││
│  │ ...                                 ││
│  └─────────────────────────────────────┘│
└────────┬────────────────────────────────┘
         │ 检测结果
         │ {"timestamp":..., "anomalyScore":..., "isAnomaly":...}
         ▼
┌─────────────────────────────────────────┐
│  结果存储                                │
│  ┌──────────────┐  ┌──────────────┐    │
│  │ Kafka 结果主题 │  │ 数据库/文件   │    │
│  │ (可选)        │  │ (可选)        │    │
│  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────┘
```

## 2. 数据流向详解

### 2.1 采集阶段

```
样机硬件
  │
  ├─ 传感器 1 (50kHz)
  ├─ 传感器 2 (60kHz)
  └─ 传感器 3 (70kHz)
  │
  ▼
┌──────────────────────────┐
│ AcousticEmissionClient   │
│ generateSignalSamples()  │
│ - 多频率信号             │
│ - 谐波                   │
│ - 随机噪声               │
│ - 异常脉冲               │
└──────────────────────────┘
  │
  ▼
┌──────────────────────────┐
│ encodeSignalData()       │
│ 二进制格式:              │
│ [8B时间戳]               │
│ [4B传感器ID]             │
│ [4B采样率]               │
│ [2B位置长度]             │
│ [nB位置字符串]           │
│ [4B采样数长度]           │
│ [4B×n采样数据]           │
└──────────────────────────┘
  │
  ▼
TCP 连接 (localhost:9090)
```

### 2.2 传输阶段

```
Netty Server
  │
  ├─ Boss Group (1 线程)
  │  └─ 接受新连接
  │
  ├─ Worker Group (8 线程)
  │  └─ 处理数据
  │
  ▼
┌──────────────────────────┐
│ SignalHandler            │
│ channelRead0()           │
│ - 读取二进制数据         │
│ - 解析字段               │
│ - 创建 SignalData        │
└──────────────────────────┘
  │
  ▼
┌──────────────────────────┐
│ KafkaProducerWrapper     │
│ send(SignalData)         │
│ - 序列化为 JSON          │
│ - 发送到 Kafka           │
└──────────────────────────┘
  │
  ▼
Kafka Broker
```

### 2.3 处理阶段

```
Kafka 消息流
  │
  ▼
┌──────────────────────────┐
│ StreamProcessor          │
│ KafkaUtils.createDirectStream()
└──────────────────────────┘
  │
  ▼
┌──────────────────────────┐
│ 消息转换                 │
│ map(record -> SignalData)│
│ filter(signal != null)   │
└──────────────────────────┘
  │
  ▼
┌──────────────────────────┐
│ 时间窗口分段             │
│ window(2000ms)           │
│ glom() - 收集为数组      │
└──────────────────────────┘
  │
  ▼
┌──────────────────────────┐
│ 异常检测                 │
│ flatMap(signalList -> {  │
│   AnomalyDetector d =    │
│     new AnomalyDetector()│
│   for each signal:       │
│     detect(signal)       │
│ })                       │
└──────────────────────────┘
  │
  ▼
┌──────────────────────────┐
│ 结果输出                 │
│ foreachRDD(rdd -> {      │
│   rdd.foreach(result)    │
│   统计信息               │
│ })                       │
└──────────────────────────┘
```

### 2.4 检测阶段

```
SignalData (原始信号)
  │
  ▼
┌──────────────────────────┐
│ SignalFilter             │
│ applyButterworthFilter() │
│ - 中心频率计算           │
│ - 带宽计算               │
│ - IIR 滤波               │
│ - Biquad 级联            │
└──────────────────────────┘
  │
  ▼
┌──────────────────────────┐
│ 能量计算                 │
│ calculateEnergy()        │
│ E = sqrt(Σ(x²)/N)        │
│ 归一化: sigmoid(E)       │
└──────────────────────────┘
  │
  ▼
┌──────────────────────────┐
│ 频域分析                 │
│ calculateFrequencyFeatures()
│ - FFT 变换               │
│ - 幅度谱计算             │
│ - 高频能量占比           │
└──────────────────────────┘
  │
  ▼
┌──────────────────────────┐
│ 异常判断                 │
│ - 能量阈值: 0.8          │
│ - 频率阈值: 0.75         │
│ - 综合评分: (E+F)/2      │
│ - 异常类型判断           │
└──────────────────────────┘
  │
  ▼
AnomalyResult
{
  timestamp: long,
  sensorId: int,
  energyLevel: double,
  frequencyScore: double,
  anomalyScore: double,
  isAnomaly: boolean,
  anomalyType: String
}
```

## 3. 关键算法

### 3.1 Butterworth 带通滤波

```
目的: 提取 10kHz - 500kHz 的声发射信号

参数:
- 阶数: 4
- 低截止频率: 10kHz
- 高截止频率: 500kHz
- 采样率: 1MHz

实现:
1. 计算归一化频率
   wLow = 2π × 10kHz / 1MHz
   wHigh = 2π × 500kHz / 1MHz

2. 计算滤波器系数 (双线性变换)
   中心频率: wc = sqrt(wLow × wHigh)
   带宽: bw = wHigh - wLow
   Q 因子: q = wc / bw

3. 应用 IIR 滤波 (Biquad 级联)
   y[n] = (b0×x[n] + b1×x[n-1] + b2×x[n-2] 
           - a1×y[n-1] - a2×y[n-2]) / a0
```

### 3.2 FFT 频域分析

```
目的: 提取频域特征用于异常检测

步骤:
1. 补零到 2 的幂次
   fftSize = 2^ceil(log2(N))

2. 执行 FFT 变换
   X[k] = Σ(n=0 to N-1) x[n] × exp(-j2πkn/N)

3. 计算幅度谱
   |X[k]| = sqrt(Re² + Im²)

4. 计算高频能量占比
   lowFreqEnergy = Σ(k=0 to N/2) |X[k]|
   highFreqEnergy = Σ(k=N/2 to N) |X[k]|
   score = highFreqEnergy / (lowFreqEnergy + highFreqEnergy)

5. 异常判断
   if score > 0.75: 频率异常
```

### 3.3 异常检测算法

```
综合评分:
anomalyScore = (energyLevel + frequencyScore) / 2

异常判断:
if anomalyScore > 0.75:
    isAnomaly = true
    
    if energyLevel > 0.8:
        anomalyType = "HIGH_ENERGY"
    else if frequencyScore > 0.8:
        anomalyType = "FREQUENCY_ANOMALY"
    else:
        anomalyType = "MIXED_ANOMALY"
else:
    isAnomaly = false
    anomalyType = "NORMAL"
```

## 4. 性能特性

### 4.1 吞吐量

```
Netty 服务器:
- 单连接: ~10,000 条/秒
- 多连接: ~50,000 条/秒 (8 线程)

Kafka:
- 单 broker: ~50,000 条/秒
- 集群 (3 broker): ~150,000 条/秒

Spark Streaming:
- local[4]: ~5,000 条/秒
- 集群 (4 executor): ~20,000 条/秒

异常检测:
- 单进程: ~2,000 条/秒
- 多进程 (4): ~8,000 条/秒
```

### 4.2 延迟

```
端到端延迟分解:

Netty 传输:          < 1ms
Kafka 消息队列:      10-50ms
Spark 批处理:        2000ms (可配置)
异常检测处理:        50-200ms
结果存储:            < 10ms
─────────────────────────────
总延迟:              ~2.1-2.3 秒
```

### 4.3 资源占用

```
内存占用:
- Netty 服务器:      ~200MB
- Kafka Broker:      ~1GB
- Spark Driver:      ~1GB
- Spark Executor:    ~2GB (可配置)
- 总计:              ~4.2GB

CPU 占用:
- Netty:             ~5-10%
- Kafka:             ~10-20%
- Spark:             ~30-50%
- 总计:              ~50-80%

磁盘占用:
- Kafka 日志:        ~100GB/天 (取决于吞吐量)
- 结果数据:          ~10GB/天
```

## 5. 扩展性设计

### 5.1 水平扩展

```
增加 Netty 服务器:
- 使用负载均衡器 (HAProxy/Nginx)
- 多个 Netty 实例监听不同端口
- 客户端连接到不同实例

增加 Kafka 分区:
- 增加 Topic 分区数
- Spark 自动并行消费

增加 Spark Executor:
- 增加 --num-executors
- 增加 --executor-cores
- 增加 --executor-memory
```

### 5.2 垂直扩展

```
增加单机性能:
- 增加 CPU 核心
- 增加内存
- 使用 SSD 存储
- 优化算法
```

## 6. 可靠性设计

### 6.1 容错机制

```
Kafka:
- 消息持久化
- 副本机制
- 消费者组管理

Spark:
- RDD 容错
- Checkpoint 机制
- 任务重试

应用层:
- 异常处理
- 重连机制
- 数据验证
```

### 6.2 监控告警

```
关键指标:
- Netty 连接数
- Kafka 消息延迟
- Spark 任务延迟
- 异常检测率
- 系统资源占用

告警规则:
- 连接数 > 1000
- 消息延迟 > 5s
- 任务失败率 > 5%
- 异常检测率 > 10%
- 内存占用 > 80%
```

---

**更新时间**: 2024年
**版本**: 1.0.0
