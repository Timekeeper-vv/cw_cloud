# 🏗️ 系统架构说明

## 📌 项目概述

**工业健康监测完整解决方案**由三个独立但协同工作的子系统组成，提供从设备管理到实时监控、从数据采集到智能分析的完整功能链路。

---

## 🎯 三大子系统

### 1. CW_Cloud 管理平台
**定位**：Web管理后台 + 微服务架构  
**技术栈**：Spring Cloud Alibaba + Vue3 + MySQL  
**端口**：48080（Gateway）、3000（Frontend）

**核心功能**：
- ✅ 用户权限管理
- ✅ IoT设备管理
- ✅ 历史数据查询
- ✅ 滤波器配置
- ✅ 系统监控

---

### 2. backend.jar 实时滤波服务
**定位**：Kafka驱动的实时计算引擎  
**技术栈**：Spring Boot + Kafka + WebSocket  
**端口**：8080

**核心功能**：
- ✅ 实时消费Kafka原始数据
- ✅ 自适应滤波算法（2种）
- ✅ WebSocket实时推送
- ✅ 处理结果发送到Kafka

---

### 3. floatdata 流处理引擎
**定位**：大数据流式处理系统  
**技术栈**：Spark Streaming + Kafka + Python  
**用途**：声发射信号分析

**核心功能**：
- ✅ 高性能数据采集（Netty）
- ✅ 分布式流处理（Spark）
- ✅ 信号处理（Butterworth + FFT）
- ✅ 异常检测算法

---

## 🔄 系统架构图

### 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层                                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │           Web浏览器 (http://localhost:3000)               │   │
│  │   登录认证 | 设备管理 | 数据查询 | 实时监控 | 信号分析     │   │
│  └────────────────────────┬─────────────────────────────────┘   │
└───────────────────────────┼─────────────────────────────────────┘
                            │ HTTP/WebSocket
┌───────────────────────────┼─────────────────────────────────────┐
│                        展示层                                     │
│  ┌────────────────────────▼─────────────────────────────────┐   │
│  │              Vue3 前端应用                                │   │
│  │  ┌──────────┬──────────┬──────────┬───────────────────┐  │   │
│  │  │ IoT页面  │ Filter页面│ 实时监控 │ 信号分析（新增）  │  │   │
│  │  └──────────┴──────────┴──────────┴───────────────────┘  │   │
│  └────────────────────────┬─────────────────────────────────┘   │
└───────────────────────────┼─────────────────────────────────────┘
                            │ REST API / WebSocket
┌───────────────────────────┼─────────────────────────────────────┐
│                       业务层（Spring Cloud）                      │
│  ┌────────────────────────▼─────────────────────────────────┐   │
│  │                   API Gateway (48080)                     │   │
│  │          负载均衡 | 路由转发 | 统一认证 | 限流熔断          │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│           ┌───────────────┼───────────────┐                     │
│  ┌────────▼────┐  ┌───────▼──────┐  ┌────▼────────┐            │
│  │   System    │  │     IoT      │  │   Filter    │            │
│  │   (48081)   │  │   (48083)    │  │   (48084)   │            │
│  │ 用户/权限    │  │  设备管理     │  │  滤波算法    │            │
│  └─────────────┘  └──────────────┘  └─────────────┘            │
│           │               │                 │                    │
│           └───────────────┼─────────────────┘                    │
│                           │                                      │
│  ┌────────────────────────▼─────────────────────────────────┐   │
│  │              Nacos服务注册中心 (8848)                      │   │
│  └──────────────────────────────────────────────────────────┘   │
└───────────────────────────┼─────────────────────────────────────┘
                            │ Kafka消息队列
┌───────────────────────────┼─────────────────────────────────────┐
│                      计算层（实时处理）                            │
│  ┌────────────────────────▼─────────────────────────────────┐   │
│  │                  Kafka消息队列 (9092)                      │   │
│  │  ┌──────────────────┬───────────────────┬──────────────┐ │   │
│  │  │ device-raw-data  │ device-filtered   │ anomaly-     │ │   │
│  │  │  (原始数据)       │    (滤波结果)      │  results     │ │   │
│  │  └──────────────────┴───────────────────┴──────────────┘ │   │
│  └──────┬─────────────────────────────────────┬─────────────┘   │
│         │                                     │                 │
│  ┌──────▼──────────┐              ┌──────────▼──────────────┐   │
│  │  backend.jar    │◄────Kafka────┤    floatdata            │   │
│  │    (8080)       │              │  Spark Streaming        │   │
│  │                 │              │                         │   │
│  │ • 实时滤波       │              │ • 信号分析               │   │
│  │ • LMS/NLMS      │              │ • 异常检测               │   │
│  │ • WebSocket推送 │              │ • FFT频谱分析            │   │
│  └─────────────────┘              └─────────────────────────┘   │
│         │                                     │                 │
│         └──────────WebSocket─────────────────┘                 │
└───────────────────────────┼─────────────────────────────────────┘
                            │
┌───────────────────────────┼─────────────────────────────────────┐
│                       数据层                                      │
│  ┌────────────────────────▼─────────────────────────────────┐   │
│  │              MySQL数据库 (3306)                            │   │
│  │  ┌──────────┬──────────┬──────────┬───────────────────┐  │   │
│  │  │ 用户数据  │ 设备数据  │ IoT数据  │ 滤波结果（存储）  │  │   │
│  │  └──────────┴──────────┴──────────┴───────────────────┘  │   │
│  └────────────────────────────────────────────────────────────  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Redis缓存 (6379)                              │   │
│  │            Session | Token | 热点数据                      │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 数据流详解

### 流程1：实时监控数据流

```
IoT设备/模拟器
    ↓ 采集数据
[1] Kafka: device-raw-data
    {deviceId: "DEVICE_001", samples: [1.2, 3.4, ...]}
    ↓
[2] backend.jar 消费处理
    - 应用LMS/NLMS滤波算法
    - 计算误差和权重
    ↓
[3] Kafka: device-filtered-data
    {deviceId, originalSamples, filteredSamples}
    ↓
┌─────────────┬─────────────────┬──────────────┐
│             │                 │              │
▼             ▼                 ▼              ▼
floatdata   WebSocket      Filter模块      前端直连
(分析)      (实时推送)     (存储MySQL)    (展示)
    │             │                 │
    ▼             ▼                 ▼
Kafka异常    浏览器实时波形     历史数据查询
结果Topic        图展示            API
```

### 流程2：历史数据查询流

```
用户在前端查询历史数据
    ↓ HTTP请求
Gateway (48080)
    ↓ 路由转发
Filter/IoT微服务
    ↓ SQL查询
MySQL数据库
    ↓ 返回结果
前端展示（表格/图表）
```

### 流程3：设备管理流

```
用户操作设备
    ↓ HTTP请求
Gateway → IoT微服务
    ↓ CRUD操作
MySQL设备表
    ↓ 发送指令（可选）
Kafka控制Topic
    ↓ 设备消费
执行控制命令
```

---

## 🎯 各系统职责矩阵

| 功能 | CW_Cloud | backend.jar | floatdata |
|------|----------|-------------|-----------|
| **设备管理** | ✅ 主要 | ❌ | ❌ |
| **用户权限** | ✅ 主要 | ❌ | ❌ |
| **数据存储** | ✅ 主要 | ❌ | ❌ |
| **实时滤波** | ⚠️ API调用 | ✅ 主要 | ❌ |
| **流式处理** | ❌ | ✅ 主要 | ✅ 主要 |
| **信号分析** | ⚠️ 结果展示 | ❌ | ✅ 主要 |
| **异常检测** | ✅ 算法提供 | ❌ | ✅ 主要 |
| **实时推送** | ❌ | ✅ 主要 | ❌ |
| **历史查询** | ✅ 主要 | ❌ | ❌ |
| **前端展示** | ✅ 主要 | ❌ | ❌ |

---

## 📊 技术栈清单

### CW_Cloud管理平台

**后端**：
- Spring Boot 2.7
- Spring Cloud Alibaba 2021
- Nacos 2.2（服务注册）
- MyBatis Plus（ORM）
- MySQL 8.0
- Redis 6.0

**前端**：
- Vue 3
- TypeScript
- Pinia（状态管理）
- Element Plus（UI组件）
- Vite（构建工具）
- ECharts（图表）

---

### backend.jar实时滤波服务

**核心**：
- Spring Boot 2.x
- Kafka Client 3.6
- WebSocket

**算法**：
- LMS自适应滤波
- NLMS自适应滤波
- Java实现的信号处理

---

### floatdata流处理引擎

**大数据**：
- Apache Spark 3.5
- Spark Streaming
- Kafka 3.6

**数据处理**：
- Netty 4.1（高性能IO）
- Apache Commons Math（数学计算）
- TDMS格式支持

**信号处理**：
- Butterworth滤波器
- FFT频域分析
- 异常检测算法

---

## 🔌 通信协议

### 1. 微服务间通信
- **协议**：HTTP REST API
- **格式**：JSON
- **认证**：JWT Token
- **服务发现**：Nacos

### 2. Kafka消息通信
- **Topics**：
  - `device-raw-data`（原始数据）
  - `device-filtered-data`（滤波结果）
  - `anomaly-results`（异常检测）
- **格式**：JSON
- **序列化**：String

### 3. 前端WebSocket
- **地址**：`ws://localhost:8080/cal`
- **用途**：实时波形推送
- **格式**：JSON
- **频率**：实时（数据到达即推送）

---

## 🗂️ 数据库设计

### MySQL核心表

```sql
-- 设备表
system_iot_device
├── id（设备ID）
├── name（设备名称）
├── type（设备类型）
├── status（运行状态）
└── create_time

-- 滤波结果表（新增）
filter_result_record
├── id
├── device_id（设备ID）
├── original_samples（原始数据JSON）
├── filtered_samples（滤波结果JSON）
├── filter_type（滤波器类型）
├── snr_improvement（SNR改善值）
└── create_time

-- 异常检测记录（新增）
anomaly_detection_record
├── id
├── device_id
├── anomaly_type（异常类型）
├── anomaly_score（异常分数）
├── alert_level（告警级别）
├── detail_json（详细信息）
└── create_time
```

---

## 🌐 端口分配

| 服务 | 端口 | 协议 | 用途 |
|------|------|------|------|
| MySQL | 3306 | TCP | 数据库 |
| Redis | 6379 | TCP | 缓存 |
| Nacos | 8848 | HTTP | 服务注册 |
| Zookeeper | 2181 | TCP | Kafka依赖 |
| Kafka | 9092 | TCP | 消息队列 |
| Gateway | 48080 | HTTP | API网关 |
| System | 48081 | HTTP | 系统服务 |
| Infra | 48082 | HTTP | 基础服务 |
| IoT | 48083 | HTTP | IoT服务 |
| Filter | 48084 | HTTP | 滤波服务 |
| backend.jar | 8080 | HTTP/WS | 实时滤波 |
| Frontend | 3000 | HTTP | Vue前端 |

---

## 🔐 安全机制

### 1. 认证授权
- JWT Token认证
- Spring Security权限控制
- RBAC角色权限模型

### 2. 数据安全
- 密码加密存储（BCrypt）
- HTTPS传输（生产环境）
- SQL注入防护（MyBatis）

### 3. 接口安全
- 请求签名验证
- 限流防刷（Sentinel）
- CORS跨域控制

---

## 📈 性能指标

### CW_Cloud管理平台
- 并发用户：100+
- 响应时间：< 500ms
- 数据库QPS：1000+

### backend.jar实时服务
- 数据吞吐量：6.5万 samples/秒
- 端到端延迟：2-3秒
- WebSocket并发：50+连接

### floatdata处理引擎
- 数据处理速度：65,000 samples/秒
- 内存占用：~4.2 GB
- Spark任务延迟：~2秒

---

## 🚀 扩展性设计

### 水平扩展
- ✅ 微服务可独立扩展
- ✅ Kafka支持分区扩展
- ✅ Spark支持集群模式

### 垂直扩展
- ✅ 增加服务器资源
- ✅ 数据库读写分离
- ✅ Redis集群模式

---

## 🔄 部署模式

### 开发环境
```
单机部署
- 所有服务在一台机器
- 内存要求：16GB
- 适合开发调试
```

### 测试环境
```
混合部署
- 基础设施独立
- 微服务集群
- 实时处理独立
```

### 生产环境
```
分布式部署
- Kubernetes集群
- 数据库主从
- Kafka集群
- Redis集群
```

---

## 📚 参考文档

- [README.md](./README.md) - 快速开始
- [三系统整合实施方案.md](./三系统整合实施方案.md) - 实施方案
- [项目部署完成报告.md](./项目部署完成报告.md) - 部署报告
- [项目迁移指南.md](./项目迁移指南.md) - 迁移指南

---

**文档版本**：v1.0  
**更新时间**：2025-11-24  
**维护人员**：项目组
