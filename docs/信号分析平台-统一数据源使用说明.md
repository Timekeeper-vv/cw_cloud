# 🎯 信号分析平台 - 统一数据源使用说明

## ✅ 功能说明

**已完成：在实时监控页面上添加历史文件数据源功能**

现在，实时监控页面支持两种数据源：
- ✅ **实时数据流** - WebSocket实时推送
- ✅ **历史文件** - TDMS文件加载

**关键特性：**
- 📡 数据源可以随时切换
- 🔄 所有显示、滤波、图表逻辑完全统一
- 📊 无论数据来自哪里，界面显示完全相同

---

## 🚀 使用方法

### 步骤1：刷新浏览器
```
Ctrl + Shift + R
```

### 步骤2：进入信号分析平台
```
实时监控 → 信号分析平台 → 实时监控标签页
```

---

## 📡 模式1：实时数据流

### 界面
```
┌─────────────────────────────────┐
│ [● 实时数据] [○ 历史文件]       │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│ 控制面板            [已连接]    │
├─────────────────────────────────┤
│ 设备选择: [DEVICE_001 ▼]        │
│ 滤波器类型: [LMS ▼]             │
│ [开始监控] / [断开连接]          │
└─────────────────────────────────┘
```

### 操作
1. 确保数据源选择 **● 实时数据**
2. 选择设备（DEVICE_001/002/TEST）
3. 点击 **[开始监控]**
4. WebSocket连接成功
5. 实时波形开始更新

---

## 📁 模式2：历史文件

### 界面
```
┌─────────────────────────────────┐
│ [○ 实时数据] [● 历史文件]       │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│ 控制面板          [历史数据]    │
├─────────────────────────────────┤
│ 历史文件: [Signal-1 ▼]          │
│ 滤波器类型: [LMS ▼]             │
│ [加载文件]                       │
└─────────────────────────────────┘
```

### 操作
1. 点击切换到 **● 历史文件**
2. 选择文件（Signal-1 或 Signal-2）
3. 点击 **[加载文件]**
4. 文件加载中...
5. 加载完成，波形显示在同样的界面上

---

## 🔄 数据源切换

### 从实时切换到历史
```
1. 如果正在监控实时数据
2. 点击 [● 历史文件]
3. WebSocket自动断开
4. 切换到历史文件模式
```

### 从历史切换到实时
```
1. 如果正在查看历史数据
2. 点击 [● 实时数据]
3. 显示WebSocket连接选项
4. 点击 [开始监控] 连接
```

---

## 📊 界面显示（完全相同）

无论数据来自实时还是历史文件，下面的界面**完全相同**：

### 实时统计面板
```
处理速度: 9810 samples/s
当前误差: 0.0152
SNR改善: 141 dB
数据包数: 7
```

### 波形图
- 原始信号 vs 滤波后信号
- 实时更新（实时模式）
- 一次性显示（历史模式）

### 频谱分析
- FFT频谱图
- 滤波前后对比

### 残差分析
- 滤波残差图表

### 异常检测
- 异常检测开关
- 异常统计（残差异常、突变异常等）

---

## 🎯 技术实现

### 数据格式统一

```typescript
// 实时WebSocket数据
{
  type: 'signal-data',
  deviceId: 'DEVICE_001',
  originalSamples: [...],
  filteredSamples: [...],
  currentError: 0.0152,
  anomalies: [...],
  statistics: {...}
}

// 历史TDMS数据（自动转换为上述格式）
loadHistoryData() {
  // 1. 从TDMS API加载
  const tdmsData = await axios.post('/api/tdms/analyze-folder')
  
  // 2. 转换为实时数据格式
  const historyData = {
    type: 'signal-data',
    deviceId: selectedFile.value,
    originalSamples: tdmsData.signals.noisy,
    filteredSamples: tdmsData.signals.filtered,
    ...
  }
  
  // 3. 使用统一的处理函数
  handleRealtimeData(historyData)  // ← 同一个函数！
}
```

### 统一处理流程

```typescript
// 不管数据来自哪里，都走这个函数
const handleRealtimeData = (data) => {
  // 1. 更新统计
  stats.value.error = data.currentError
  stats.value.snrImprovement = calculateSNR(data)
  
  // 2. 更新波形图
  updateWaveformChart(data)
  
  // 3. 更新残差图
  updateResidualChart(data)
  
  // 4. 异常检测
  if (data.anomalies) {
    processAnomalyResults(data.anomalies)
  }
}
```

---

## ⚙️ 前置条件

### 实时数据模式
```bash
# 需要启动WebSocket Bridge
node websocket-bridge.js

# 需要启动Backend服务
java -jar backend.jar
```

### 历史文件模式
```bash
# 需要启动TDMS API Server
node tdms-api-server.js

# 检查端口
netstat -ano | findstr ":3002"
```

---

## 🎨 界面截图说明

### 实时数据模式
- 顶部显示：[● 实时数据] [○ 历史文件]
- 控制面板标签：[已连接] (绿色)
- 设备选择下拉框
- [断开连接] 按钮

### 历史文件模式
- 顶部显示：[○ 实时数据] [● 历史文件]
- 控制面板标签：[历史数据] (橙色)
- 历史文件选择下拉框
- [加载文件] 按钮

---

## 🐛 故障排查

### 问题1：历史文件加载失败

**症状：** 点击"加载文件"后提示"加载失败"

**解决：**
```bash
# 1. 检查TDMS API是否运行
netstat -ano | findstr ":3002"

# 2. 如果没有，启动它
node tdms-api-server.js

# 3. 重新点击"加载文件"
```

### 问题2：实时数据连接失败

**症状：** 点击"开始监控"后提示"连接失败"

**解决：**
```bash
# 1. 检查WebSocket Bridge
netstat -ano | findstr ":8081"

# 2. 如果没有，启动它
node websocket-bridge.js

# 3. 检查Backend服务
# 确保backend.jar正在运行

# 4. 重新点击"开始监控"
```

### 问题3：界面没有更新

**症状：** 数据源切换后界面没有变化

**解决：**
```bash
# 硬刷新浏览器
Ctrl + Shift + R

# 或清除缓存
F12 → Application → Clear storage
```

---

## 📝 总结

### ✅ 已实现

- [x] 在实时监控页面添加数据源选择器
- [x] 支持切换实时数据和历史文件
- [x] 历史文件数据自动转换为实时格式
- [x] 所有显示逻辑完全统一
- [x] 滤波、图表、异常检测逻辑复用100%

### 🎯 核心优势

1. **用户体验统一** - 无需切换页面
2. **代码完全复用** - 一套逻辑处理所有数据
3. **维护成本最低** - 只需维护一个组件
4. **功能扩展简单** - 新增数据源只需添加转换逻辑

---

## 🚀 立即体验

```
1. 刷新浏览器 (Ctrl+Shift+R)
2. 进入：实时监控 → 信号分析平台
3. 点击顶部：[● 历史文件]
4. 选择：Signal-1
5. 点击：[加载文件]
6. 观察：波形图、统计面板、异常检测
7. 切换回：[● 实时数据]
8. 点击：[开始监控]
9. 对比：界面完全相同！✅
```

**享受统一的数据分析体验！** 🎉
