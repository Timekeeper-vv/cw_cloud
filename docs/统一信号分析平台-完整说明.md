# 🚀 统一信号分析平台 - 完整说明

## 📋 目录
- [项目概述](#项目概述)
- [架构设计](#架构设计)
- [功能特性](#功能特性)
- [快速开始](#快速开始)
- [使用指南](#使用指南)
- [技术实现](#技术实现)
- [故障排查](#故障排查)

---

## 项目概述

### 🎯 设计理念

**将"实时滤波监控"和"TDMS历史分析"完全统一**，实现：
- ✅ 统一数据源（实时/历史/上传）
- ✅ 统一滤波引擎（Butterworth/LMS/NLMS）
- ✅ 统一图表渲染
- ✅ 统一指标计算
- ✅ **代码复用率100%**

### 📊 架构对比

| 特性 | 旧方案（2个独立页面） | 新方案（统一平台）⭐ |
|------|---------------------|-------------------|
| **菜单项** | 2个 | 1个 |
| **代码量** | ~1400行 × 2 | ~600行 |
| **滤波算法** | 分散实现 | 统一引擎 |
| **维护成本** | 修改2处 | 修改1处 |
| **用户体验** | 页面跳转 | 一键切换 |
| **扩展性** | 困难 | 简单 |

---

## 架构设计

### 🏗️ 整体架构

```
┌─────────────────────────────────────────────┐
│         统一信号分析平台                      │
├─────────────────────────────────────────────┤
│                                             │
│  ┌─────────────────────────────────┐       │
│  │   数据源选择器                    │       │
│  │   ● 实时  ○ 历史  ○ 上传         │       │
│  └─────────────────────────────────┘       │
│              ↓                              │
│  ┌─────────────────────────────────┐       │
│  │     数据适配器 (dataAdapter)      │       │
│  │  • loadHistoryData()             │       │
│  │  • connectRealtimeData()         │       │
│  │  • loadUploadData()              │       │
│  └─────────────────────────────────┘       │
│              ↓                              │
│  ┌─────────────────────────────────┐       │
│  │   标准化数据格式                  │       │
│  │   { time, original, noisy,       │       │
│  │     sampleRate, source }         │       │
│  └─────────────────────────────────┘       │
│              ↓                              │
│  ┌─────────────────────────────────┐       │
│  │   滤波引擎 (filterEngine)        │       │
│  │  • applyButterworthFilter()      │       │
│  │  • applyLMSFilter()              │       │
│  │  • applyNLMSFilter()             │       │
│  └─────────────────────────────────┘       │
│              ↓                              │
│  ┌─────────────────────────────────┐       │
│  │   指标计算器 (metricsCalculator) │       │
│  │  • calculateMSE()                │       │
│  │  • calculateSNR()                │       │
│  │  • calculateCorrelation()        │       │
│  └─────────────────────────────────┘       │
│              ↓                              │
│  ┌─────────────────────────────────┐       │
│  │   共享UI组件                      │       │
│  │  • FilterConfig                  │       │
│  │  • MetricsPanel                  │       │
│  │  • SignalCharts (ECharts)        │       │
│  └─────────────────────────────────┘       │
│                                             │
└─────────────────────────────────────────────┘
```

### 📁 文件结构

```
yudao-ui-admin-vue3/
├── src/
│   ├── utils/
│   │   └── signal/                    ← 共享工具类
│   │       ├── filterEngine.ts        # 统一滤波引擎
│   │       ├── dataAdapter.ts         # 数据源适配器
│   │       └── metricsCalculator.ts   # 指标计算器
│   │
│   └── views/
│       └── realtime/
│           ├── UnifiedSignalAnalysis.vue  ← 统一主页面
│           └── shared/                     ← 共享UI组件
│               ├── FilterConfig.vue        # 滤波配置组件
│               └── MetricsPanel.vue        # 指标面板组件
│
└── tdms-api-server.js                 ← 后端API服务器

数据库:
├── update-unified-signal-menu.sql     ← 菜单更新SQL
└── execute-unified-signal-menu.bat    ← 执行脚本
```

---

## 功能特性

### 📡 实时数据流监控

```
功能：
  ✅ WebSocket连接（ws://localhost:8081/realtime）
  ✅ 设备选择（DEVICE_001/002/TEST）
  ✅ LMS/NLMS自适应滤波
  ✅ 实时统计（处理速度、数据包数）
  ✅ 异常检测（可选）

使用场景：
  - 生产环境实时监控
  - 设备状态实时追踪
  - 故障早期预警
```

### 📁 历史文件分析

```
功能：
  ✅ TDMS文件读取
  ✅ Signal-1（单文件多通道）
  ✅ Signal-2（多文件组合）
  ✅ Butterworth低通滤波
  ✅ 性能指标评估

使用场景：
  - 历史数据回溯分析
  - 滤波参数优化
  - 性能基准测试
```

### 🎛️ 统一滤波引擎

| 滤波器类型 | 适用场景 | 参数 | 说明 |
|-----------|---------|------|-----|
| **Butterworth** | 历史数据 | 采样率、截止频率、阶数 | 相位线性、通带平坦 |
| **LMS** | 实时数据 | 步长、滤波器长度 | 自适应、收敛快 |
| **NLMS** | 实时数据 | 步长、滤波器长度 | 归一化LMS、更稳定 |
| **Kalman** | 高级应用 | - | 即将上线 |

### 📊 性能指标

```
✅ MSE (均方误差)
   - 滤波前/后对比
   - 改善百分比
   
✅ 相关系数
   - 信号相似度
   - 滤波保真度
   
✅ SNR (信噪比)
   - dB单位
   - 改善量
   
✅ 处理性能
   - 处理时间（ms）
   - 吞吐量（samples/s）
```

---

## 快速开始

### 1️⃣ 执行数据库更新

```bash
# 双击运行
execute-unified-signal-menu.bat

# 或手动执行
mysql -u root -p ruoyi-vue-pro < update-unified-signal-menu.sql
```

**输入密码后，等待更新完成。**

### 2️⃣ 重启前端服务

```bash
# 停止当前前端（Ctrl+C）
cd yudao-ui-admin-vue3
npm run dev
```

### 3️⃣ 启动后端服务

```bash
# TDMS API Server（端口3002）
node tdms-api-server.js

# WebSocket Bridge（端口8081）
node websocket-bridge.js
```

### 4️⃣ 访问新平台

```
1. 打开浏览器：http://localhost:3000
2. 登录系统
3. 菜单：实时监控 → 信号分析平台
4. 选择数据源，开始分析！
```

---

## 使用指南

### 📡 实时监控模式

#### 步骤1：选择数据源
```
点击：● 实时数据流
```

#### 步骤2：选择设备
```
设备下拉框 → 选择 DEVICE_001
```

#### 步骤3：配置滤波器
```
滤波器类型：LMS
步长：0.01
滤波器长度：32
```

#### 步骤4：开始监控
```
点击：[开始监控]
```

#### 结果
- ✅ 右上角显示绿点（已连接）
- ✅ 实时统计更新
- ✅ 波形图实时刷新
- ✅ 性能指标实时计算

---

### 📁 历史分析模式

#### 步骤1：选择数据源
```
点击：○ 历史文件 → ● 历史文件
```

#### 步骤2：选择文件
```
点击：Signal-1 或 Signal-2
```

#### 步骤3：配置滤波器
```
滤波器类型：Butterworth
采样率：100000 Hz
截止频率：5000 Hz  ← 重要！设为信号频率的1.2-1.5倍
滤波阶数：6
```

#### 步骤4：开始分析
```
点击：[开始分析]
```

#### 结果
- ✅ 显示4条波形（原始、加噪、滤波、对比）
- ✅ MSE改善：应该在 80-90% 范围
- ✅ 相关系数：应该接近 1.0
- ✅ SNR改善：10-20 dB

---

### 🎛️ 滤波参数调优

#### Butterworth参数建议

| 信号频率 | 推荐截止频率 | 说明 |
|---------|------------|-----|
| 1kHz | 1200-1500 Hz | 1.2-1.5倍 |
| 5kHz | 6000-7500 Hz | 保留主频，滤除高频噪声 |
| 10kHz | 12000-15000 Hz | 根据采样率调整 |

**⚠️ 重要提示：**
- 截止频率太低 → 信号被滤除（MSE改善为负）
- 截止频率太高 → 噪声通过（MSE改善很小）
- 阶数太高 → 相位失真（相关系数下降）

#### LMS/NLMS参数建议

| 步长 | 收敛速度 | 稳定性 | 适用场景 |
|------|---------|-------|---------|
| 0.001 | 慢 | 高 | 低噪声环境 |
| 0.01 | 中 | 中 | 通用场景 ⭐ |
| 0.1 | 快 | 低 | 快速变化信号 |

---

## 技术实现

### 🔧 核心代码示例

#### 1. 数据适配器使用

```typescript
import { dataAdapter } from '@/utils/signal/dataAdapter'

// 加载历史数据
const data = await dataAdapter.loadHistoryData('signal-1')

// 连接实时数据
dataAdapter.connectRealtimeData(
  'DEVICE_001',
  (data) => console.log('收到数据', data),
  (error) => console.error('错误', error)
)

// 断开连接
dataAdapter.disconnectRealtimeData()
```

#### 2. 滤波引擎使用

```typescript
import { filterEngine } from '@/utils/signal/filterEngine'

// 应用Butterworth滤波
const result = await filterEngine.applyFilter(
  { time, signal, sampleRate },
  {
    type: 'butterworth',
    sampleRate: 100000,
    cutoffFreq: 5000,
    order: 6
  }
)

// 结果
console.log('滤波后信号:', result.filtered)
console.log('性能指标:', result.metrics)
```

#### 3. 指标计算器使用

```typescript
import { metricsCalculator } from '@/utils/signal/metricsCalculator'

// 计算综合指标
const metrics = metricsCalculator.calculateComprehensiveMetrics(
  original,   // 原始信号
  noisy,      // 加噪信号
  filtered,   // 滤波后信号
  processingTime
)

// 格式化显示
const formatted = metricsCalculator.formatMetrics(metrics)
console.log(formatted)
// 输出：{ 'MSE改善': '85.30%', '相关系数(后)': '0.9823', ... }
```

---

## 故障排查

### ❌ 问题1：页面空白

**症状：** 点击菜单后页面空白，无内容

**原因：**
1. 前端缓存未清除
2. 路由未更新
3. 组件加载失败

**解决：**
```bash
# 1. 硬刷新浏览器
Ctrl + Shift + R

# 2. 清除浏览器缓存
F12 → Application → Clear storage

# 3. 重启前端
cd yudao-ui-admin-vue3
npm run dev
```

---

### ❌ 问题2：MSE改善为负数

**症状：** MSE改善显示 -900%，相关系数接近0

**原因：** 截止频率设置不当

**解决：**
```
1. 检查信号主频率（例如：5000 Hz）
2. 设置截止频率 = 信号频率 × 1.3
3. 示例：5000Hz × 1.3 = 6500Hz
4. 重新分析
```

**正确的结果：**
- MSE改善：80-90%
- 相关系数：0.95-0.99

---

### ❌ 问题3：实时连接失败

**症状：** WebSocket connection failed

**原因：** WebSocket Bridge未运行

**解决：**
```bash
# 1. 检查端口
netstat -ano | findstr ":8081"

# 2. 启动WebSocket Bridge
node websocket-bridge.js

# 3. 重新连接
点击 [开始监控]
```

---

### ❌ 问题4：历史分析500错误

**症状：** 后端API未连接，500错误

**原因：** TDMS API Server未运行

**解决：**
```bash
# 1. 检查端口
netstat -ano | findstr ":3002"

# 2. 启动TDMS API Server
node tdms-api-server.js

# 3. 重新分析
点击 [开始分析]
```

---

## 🎉 完成！

### ✅ 验证清单

- [ ] 数据库菜单更新成功
- [ ] 浏览器显示"信号分析平台"
- [ ] 实时模式可以连接设备
- [ ] 历史模式可以分析文件
- [ ] MSE改善为正数（80%+）
- [ ] 相关系数接近1.0
- [ ] 图表正常显示
- [ ] 性能指标正确计算

---

## 📚 相关文档

- [TDMS文件夹分析功能说明.md](./TDMS文件夹分析功能说明.md)
- [信号分析平台整合说明.md](./信号分析平台整合说明.md)
- [问题修复说明.md](./问题修复说明.md)

---

## 🚀 后续扩展

### 计划功能

1. **文件上传**
   - 支持拖拽上传
   - 支持多种格式（.tdms, .csv, .txt）
   - 自动识别采样率

2. **Kalman滤波**
   - 状态空间模型
   - 最优估计

3. **对比分析**
   - 多文件对比
   - 不同滤波器对比
   - 性能基准测试

4. **导出功能**
   - 导出滤波后数据
   - 导出分析报告
   - 导出图表

---

## 📞 技术支持

如有问题，请检查：
1. 前端控制台（F12 → Console）
2. 后端日志（Node.js终端）
3. 数据库连接状态

**祝使用愉快！** 🎊
