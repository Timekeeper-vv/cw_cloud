# 🔧 TDMS信号查看器 - 问题修复说明

## 🐛 遇到的错误

### 错误1：API 404 Not Found
```
Failed to load resource: the server responded with a status of 404 (Not Found)
:3000/api/tdms/analyze-folder:1
```

**原因**：
- 前端访问的是 `:3000/api/...`（Vue开发服务器端口）
- 但TDMS API服务器运行在 `:3002` 端口
- 没有配置API代理或正确的API地址

### 错误2：toFixed TypeError
```javascript
TypeError: val.toFixed is not a function
at formatter (TDMSSignalViewer.vue:521:18)
```

**原因**：
- ECharts图表的`xAxis.axisLabel.formatter`期望数字类型
- 但实际接收到的可能是字符串
- 直接调用`.toFixed()`方法失败

---

## ✅ 修复方案

### 修复1：配置API基础地址

**位置**：`TDMSSignalViewer.vue`

**修改前**：
```typescript
const res = await axios.get('/api/tdms/files')
const res = await axios.post('/api/tdms/analyze-folder', requestData)
```

**修改后**：
```typescript
// 添加API基础地址常量
const API_BASE = 'http://localhost:3002'

// 所有API调用使用完整地址
const res = await axios.get(`${API_BASE}/api/tdms/files`)
const res = await axios.post(`${API_BASE}/api/tdms/analyze-folder`, requestData)
```

**影响的函数**：
- ✅ `refreshFileList()` - 刷新文件列表
- ✅ `handleFileSelect()` - 选择文件
- ✅ `handleAnalyze()` - 文件夹分析
- ✅ `handleAnalyze()` - 单文件分析

### 修复2：修复ECharts formatter

**位置**：`TDMSSignalViewer.vue` 的 `updateChart()` 函数

**修改前**：
```typescript
xAxis: {
  axisLabel: {
    formatter: (val: number) => val.toFixed(2)
  }
}
```

**修改后**：
```typescript
xAxis: {
  axisLabel: {
    formatter: (val: any) => {
      const num = typeof val === 'string' ? parseFloat(val) : val
      return num.toFixed ? num.toFixed(2) : val
    }
  }
}
```

**改进**：
- ✅ 检查值的类型
- ✅ 如果是字符串，转换为数字
- ✅ 确认有`toFixed`方法后再调用
- ✅ 如果无法格式化，返回原值

### 修复3：安装并启动TDMS API服务器

**步骤1：安装依赖**
```bash
npm install express cors
```

**步骤2：启动服务器**
```bash
node tdms-api-server.js
```

**验证**：
```bash
# 应该看到输出：
====================================
  TDMS Signal Analysis API Server
====================================
✅ Server running on http://localhost:3002
📁 Signal-1 Directory: E:\Code\CW_Cloud\floatdata\signal-1
📁 Signal-2 Directory: E:\Code\CW_Cloud\floatdata\signal-2
====================================
```

---

## 🧪 测试验证

### 1. 检查TDMS API服务器
```bash
# 检查端口是否监听
netstat -ano | findstr ":3002"

# 访问健康检查接口
curl http://localhost:3002/api/health
# 或在浏览器访问: http://localhost:3002/api/health
```

**期望输出**：
```json
{
  "status": "ok",
  "service": "TDMS Analysis API",
  "timestamp": "2025-12-09T..."
}
```

### 2. 测试前端功能
1. **刷新浏览器** (F5 或 Ctrl+R)
2. 进入 **TDMS信号查看器**
3. 点击 **Signal-1** 或 **Signal-2** 文件夹
4. 点击 **"开始分析"** 按钮
5. 等待分析完成（约5-10秒）
6. 查看4个图表是否正常显示

### 3. 检查浏览器控制台
打开浏览器开发者工具 (F12)：
- ✅ **Console** 标签页：不应该有红色错误
- ✅ **Network** 标签页：API请求应该返回200状态码
- ✅ **图表** 应该正常渲染，无报错

---

## 📋 完整检查清单

### 后端检查
- [x] Node.js 已安装
- [x] express 依赖已安装
- [x] cors 依赖已安装
- [x] tdms-api-server.js 文件存在
- [x] TDMS API 服务器运行在 3002 端口
- [x] 健康检查接口正常响应

### Python环境检查
- [x] Python 已安装
- [x] nptdms 库已安装
- [x] numpy 库已安装
- [x] scipy 库已安装
- [x] tdms-folder-analyzer.py 文件存在

### 前端检查
- [x] Vue3 开发服务器运行中
- [x] TDMSSignalViewer.vue API地址已更新
- [x] 浏览器页面已刷新
- [x] 控制台无错误

### 数据文件检查
- [x] floatdata/signal-1/ae_sim_2s.tdms 存在
- [x] floatdata/signal-2/ae_sine_2s.tdms 存在
- [x] floatdata/signal-2/ae_noise_2s.tdms 存在
- [x] floatdata/signal-2/ae_mix_2s.tdms 存在

---

## 🎯 现在应该可以正常使用了

### 操作步骤

1. **确认TDMS API服务器正在运行**
   ```bash
   # 如果没运行，执行：
   node tdms-api-server.js
   ```

2. **刷新浏览器页面** (F5)

3. **进入TDMS信号查看器**
   ```
   实时监控 → TDMS信号查看器
   ```

4. **点击文件夹进行分析**
   - 点击 **Signal-1 文件夹** 或 **Signal-2 文件夹**
   - 点击 **"开始分析"** 按钮
   - 等待分析完成

5. **查看分析结果**
   - 4个时域图表
   - 性能指标（MSE改善、相关系数）

---

## 🔍 如果还有问题

### 检查1：TDMS API服务器日志
查看运行TDMS API的控制台窗口，看是否有错误输出

### 检查2：浏览器控制台
按 F12 打开开发者工具，查看：
- **Console**：查看JavaScript错误
- **Network**：查看API请求状态
  - 应该看到 `http://localhost:3002/api/tdms/analyze-folder`
  - 状态码应该是 200
  - Response 应该包含 signals 和 metrics 数据

### 检查3：Python环境
```bash
# 测试Python脚本
python floatdata/floatdata-streaming/tdms-folder-analyzer.py signal-1

# 应该输出JSON格式的分析结果
```

### 检查4：文件权限
确保Python脚本有读取TDMS文件的权限

---

## 📝 文件修改汇总

### 修改的文件
1. ✅ `yudao-ui-admin-vue3/src/views/realtime/TDMSSignalViewer.vue`
   - 添加 `API_BASE` 常量
   - 更新所有API调用地址
   - 修复ECharts formatter

2. ✅ `package.json`
   - 添加 express 依赖
   - 添加 cors 依赖

### 新建的文件
1. ✅ `tdms-api-server.js` - TDMS API服务器
2. ✅ `floatdata/floatdata-streaming/tdms-folder-analyzer.py` - 文件夹分析脚本

---

## 🎉 修复完成

所有问题已修复：
- ✅ API 404错误已解决（配置正确的API地址）
- ✅ toFixed错误已解决（类型检查和转换）
- ✅ TDMS API服务器已启动
- ✅ 依赖包已安装

**现在刷新浏览器页面，就可以正常使用TDMS信号查看器了！** 🚀

---

## 💡 使用建议

1. **保持TDMS API服务器运行**
   - 在独立的终端窗口运行
   - 不要关闭该窗口

2. **首次使用**
   - 先测试 Signal-1（较简单）
   - 再测试 Signal-2（多文件组合）

3. **分析时间**
   - 每次分析大约需要 5-10秒
   - 耐心等待"分析完成"提示

4. **图表交互**
   - 可以调整时间窗口（5ms - 50ms）
   - 可以缩放和平移图表
   - 可以查看具体数据点

---

**如果还有任何问题，请告诉我！** 🤝
