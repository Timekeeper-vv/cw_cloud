# 高速滤波服务部署指南

## 概述

高速滤波服务 (`high-speed-filter-service.py`) 是用 Python 实现的高性能信号滤波服务，用于替代 `backend.jar`。

## 快速部署 (服务器)

```bash
# 一键部署
ssh root@8.145.42.157
cd /opt/cw-cloud/CW_Cloud
chmod +x scripts/deploy-filter-service.sh
./scripts/deploy-filter-service.sh
```

### 性能对比

| 指标 | backend.jar | Python滤波服务 |
|------|-------------|----------------|
| 处理速度 | ~10K/s | 100K-500K/s |
| 内存占用 | ~500MB | ~100MB |
| 启动时间 | 10-20s | 1-2s |
| 配置灵活性 | 低 | 高 |

### 支持的滤波算法

1. **LMS (最小均方)** - 自适应滤波，适合去除相关噪声
2. **Kalman (卡尔曼)** - 状态估计滤波，适合平滑信号
3. **LowPass (低通)** - Butterworth低通滤波
4. **BandPass (带通)** - Butterworth带通滤波

## 安装依赖

```bash
# Linux/服务器
pip3 install numpy kafka-python scipy lz4

# Windows
pip install numpy kafka-python scipy lz4
```

## 快速启动

### Linux/服务器

```bash
# 基本启动
cd /opt/cw-cloud/CW_Cloud
python3 services/high-speed-filter-service.py

# 使用启动脚本
chmod +x scripts/start-filter-service.sh
./scripts/start-filter-service.sh

# 多线程模式 (推荐)
./scripts/start-filter-service.sh --multithread --workers 8

# 使用卡尔曼滤波
./scripts/start-filter-service.sh --algorithm kalman
```

### Windows

```batch
# 基本启动
python services\high-speed-filter-service.py

# 使用启动脚本
scripts\start-filter-service.bat

# 多线程模式
scripts\start-filter-service.bat --multithread --workers 4
```

## 命令行参数

| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| --brokers | -b | localhost:9092 | Kafka服务器地址 |
| --input-topic | | sample-input | 输入主题 |
| --output-topic | | sample-output | 输出主题 |
| --group | | python-filter-service | 消费者组 |
| --algorithm | -a | lms | 滤波算法 |
| --workers | -w | 4 | 工作线程数 |
| --multithread | -m | false | 启用多线程 |
| --batch-size | | 500 | 批量拉取大小 |
| --lms-order | | 32 | LMS滤波器阶数 |
| --lms-mu | | 0.01 | LMS学习率 |
| --kalman-q | | 0.001 | 卡尔曼过程噪声 |
| --kalman-r | | 0.1 | 卡尔曼测量噪声 |

## 服务器部署

### 1. 上传文件

```bash
# 从本地上传到服务器
scp services/high-speed-filter-service.py root@8.145.42.157:/opt/cw-cloud/CW_Cloud/services/
scp scripts/start-filter-service.sh root@8.145.42.157:/opt/cw-cloud/CW_Cloud/scripts/
scp scripts/stop-filter-service.sh root@8.145.42.157:/opt/cw-cloud/CW_Cloud/scripts/
```

### 2. 安装依赖

```bash
ssh root@8.145.42.157
pip3 install numpy kafka-python scipy lz4
```

### 3. 启动服务

```bash
cd /opt/cw-cloud/CW_Cloud

# 停止旧的 backend.jar (如果运行中)
pkill -f backend.jar

# 启动新服务
chmod +x scripts/start-filter-service.sh scripts/stop-filter-service.sh
./scripts/start-filter-service.sh --multithread --workers 8 --algorithm lms
```

### 4. 验证运行

```bash
# 查看日志
tail -f logs/filter-service.log

# 检查进程
ps aux | grep high-speed-filter

# 检查Kafka输出
kafkacat -b localhost:9092 -t sample-output -C -c 5
```

## 使用 PM2 管理 (推荐)

```bash
# 安装 PM2
npm install -g pm2

# 启动服务
pm2 start services/high-speed-filter-service.py \
    --name filter-service \
    --interpreter python3 \
    -- --multithread --workers 8

# 查看状态
pm2 status

# 查看日志
pm2 logs filter-service

# 停止服务
pm2 stop filter-service

# 设置开机自启
pm2 startup
pm2 save
```

## 数据流

```
TDMS文件 → tdms-kafka-producer-ultra.py → [sample-input]
                                              ↓
                                    high-speed-filter-service.py
                                              ↓
                                        [sample-output]
                                              ↓
                                    websocket-bridge.js → 前端
```

## 输出消息格式

```json
{
  "deviceId": "tdms-file1-group1-channel1",
  "timestamp": 1702800000000,
  "processedAt": 1702800000100,
  "sampleRate": 50000,
  "originalSamples": [0.1, 0.2, ...],
  "filteredSamples": [0.15, 0.18, ...],
  "sampleCount": 10000,
  "snrBefore": 15.5,
  "snrAfter": 28.3,
  "snrImprovement": 12.8,
  "processingTimeMs": 5.2,
  "filterType": "LMS",
  "metadata": {...}
}
```

## 性能调优

### 提高吞吐量

```bash
# 增加工作线程
./scripts/start-filter-service.sh --multithread --workers 16

# 增加批量大小
python3 services/high-speed-filter-service.py --batch-size 1000
```

### 降低延迟

```bash
# 减少批量大小
python3 services/high-speed-filter-service.py --batch-size 100

# 使用单线程模式
python3 services/high-speed-filter-service.py
```

### 算法选择

- **实时去噪**: 使用 `--algorithm lms`
- **平滑信号**: 使用 `--algorithm kalman`
- **去除高频噪声**: 使用 `--algorithm lowpass`
- **提取特定频段**: 使用 `--algorithm bandpass`

## 故障排除

### 服务无法启动

```bash
# 检查依赖
python3 -c "import numpy; import kafka; from scipy import signal; print('OK')"

# 检查Kafka连接
kafkacat -b localhost:9092 -L
```

### 处理速度慢

1. 启用多线程模式
2. 增加工作线程数
3. 检查Kafka配置是否优化
4. 检查服务器CPU使用率

### 内存不足

```bash
# 减少队列大小 (修改代码中的 queue_size)
# 或减少批量大小
python3 services/high-speed-filter-service.py --batch-size 200
```

## 与 backend.jar 共存

如果需要同时运行两个服务进行对比：

```bash
# backend.jar 使用不同的消费者组
java -jar backend.jar --spring.kafka.consumer.group-id=backend-group

# Python服务使用默认组
python3 services/high-speed-filter-service.py
```

## 完全替代 backend.jar

1. 停止 backend.jar
2. 启动 Python 滤波服务
3. 确认前端正常显示数据
4. 删除 backend.jar 相关启动脚本
