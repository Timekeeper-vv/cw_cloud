# æƒé™æ ¡éªŒé€»è¾‘è¯¦è§£

## ğŸ“š ç›®å½•

1. [æƒé™æ ¡éªŒæµç¨‹æ¦‚è§ˆ](#æƒé™æ ¡éªŒæµç¨‹æ¦‚è§ˆ)
2. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
3. [æƒé™æ ¡éªŒå®ç°](#æƒé™æ ¡éªŒå®ç°)
4. [æ•°æ®æƒé™å®ç°](#æ•°æ®æƒé™å®ç°)
5. [ç¼“å­˜æœºåˆ¶](#ç¼“å­˜æœºåˆ¶)
6. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)

---

## ğŸ¯ æƒé™æ ¡éªŒæµç¨‹æ¦‚è§ˆ

### å®Œæ•´è°ƒç”¨é“¾è·¯

```
HTTPè¯·æ±‚
    â†“
TokenAuthenticationFilter (Tokenè®¤è¯è¿‡æ»¤å™¨)
    â†“
@PreAuthorize("@ss.hasPermission('system:user:create')") (Spring Securityæ³¨è§£)
    â†“
SecurityFrameworkService (æƒé™æ¡†æ¶æœåŠ¡ - Beanåç§°: "ss")
    â†“
PermissionService (ç³»ç»Ÿæƒé™æœåŠ¡)
    â†“
æŸ¥è¯¢ç”¨æˆ·è§’è‰² â†’ æŸ¥è¯¢è§’è‰²èœå• â†’ åˆ¤æ–­æƒé™
    â†“
è¿”å› true/false
```

---

## ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶

### 1. Controllerå±‚ - @PreAuthorizeæ³¨è§£

```java
@RestController
@RequestMapping("/system/user")
public class UserController {
    
    @PostMapping("/create")
    @Operation(summary = "æ–°å¢ç”¨æˆ·")
    @PreAuthorize("@ss.hasPermission('system:user:create')")  // æƒé™æ ¡éªŒ
    public CommonResult<Long> createUser(@Valid @RequestBody UserSaveReqVO reqVO) {
        Long id = userService.createUser(reqVO);
        return success(id);
    }
    
    @DeleteMapping("/delete")
    @PreAuthorize("@ss.hasPermission('system:user:delete')")  // æƒé™æ ¡éªŒ
    public CommonResult<Boolean> deleteUser(@RequestParam("id") Long id) {
        userService.deleteUser(id);
        return success(true);
    }
    
    @GetMapping("/page")
    @PreAuthorize("@ss.hasPermission('system:user:query')")   // æƒé™æ ¡éªŒ
    public CommonResult<PageResult<UserRespVO>> getUserPage(@Valid UserPageReqVO pageReqVO) {
        PageResult<AdminUserDO> pageResult = userService.getUserPage(pageReqVO);
        return success(BeanUtils.toBean(pageResult, UserRespVO.class));
    }
}
```

**æ³¨è§£è¯´æ˜**ï¼š
- `@ss` - Springå®¹å™¨ä¸­åä¸º"ss"çš„Beanï¼ˆSecurityFrameworkServiceï¼‰
- `hasPermission('system:user:create')` - è°ƒç”¨è¯¥Beançš„hasPermissionæ–¹æ³•
- æƒé™æ ‡è¯†æ ¼å¼ï¼š`${ç³»ç»Ÿ}:${æ¨¡å—}:${æ“ä½œ}`
  - `system` - ç³»ç»Ÿæ ‡è¯†
  - `user` - ç”¨æˆ·æ¨¡å—
  - `create` - åˆ›å»ºæ“ä½œ

---

### 2. SecurityFrameworkService - æƒé™æ¡†æ¶æœåŠ¡

#### æ¥å£å®šä¹‰

```java
/**
 * Security æ¡†æ¶ Service æ¥å£ï¼Œå®šä¹‰æƒé™ç›¸å…³çš„æ ¡éªŒæ“ä½œ
 */
public interface SecurityFrameworkService {
    
    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æƒé™
     */
    boolean hasPermission(String permission);
    
    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æƒé™ï¼Œä»»ä¸€ä¸€ä¸ªå³å¯
     */
    boolean hasAnyPermissions(String... permissions);
    
    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰è§’è‰²
     * æ³¨æ„ï¼šè§’è‰²ä½¿ç”¨çš„æ˜¯ RoleDO çš„ code æ ‡è¯†
     */
    boolean hasRole(String role);
    
    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰è§’è‰²ï¼Œä»»ä¸€ä¸€ä¸ªå³å¯
     */
    boolean hasAnyRoles(String... roles);
    
    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æˆæƒèŒƒå›´
     */
    boolean hasScope(String scope);
    
    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æˆæƒèŒƒå›´ï¼Œä»»ä¸€ä¸€ä¸ªå³å¯
     */
    boolean hasAnyScopes(String... scope);
}
```

#### å®ç°ç±»

```java
@AllArgsConstructor
public class SecurityFrameworkServiceImpl implements SecurityFrameworkService {
    
    private final PermissionCommonApi permissionApi;  // RPCè°ƒç”¨æƒé™API
    
    /**
     * æƒé™ç¼“å­˜ - 1åˆ†é’Ÿè¿‡æœŸ
     * Key: <userId, List<permissions>>
     * Value: Boolean (æ˜¯å¦æœ‰æƒé™)
     */
    private final LoadingCache<KeyValue<Long, List<String>>, Boolean> hasAnyPermissionsCache = 
        buildCache(Duration.ofMinutes(1L), new CacheLoader<>() {
            @Override
            public Boolean load(KeyValue<Long, List<String>> key) {
                return permissionApi.hasAnyPermissions(
                    key.getKey(),  // userId
                    key.getValue().toArray(new String[0])  // permissions
                ).getCheckedData();
            }
        });
    
    /**
     * è§’è‰²ç¼“å­˜ - 1åˆ†é’Ÿè¿‡æœŸ
     */
    private final LoadingCache<KeyValue<Long, List<String>>, Boolean> hasAnyRolesCache = 
        buildCache(Duration.ofMinutes(1L), new CacheLoader<>() {
            @Override
            public Boolean load(KeyValue<Long, List<String>> key) {
                return permissionApi.hasAnyRoles(
                    key.getKey(), 
                    key.getValue().toArray(new String[0])
                ).getCheckedData();
            }
        });
    
    @Override
    public boolean hasPermission(String permission) {
        return hasAnyPermissions(permission);
    }
    
    @Override
    @SneakyThrows
    public boolean hasAnyPermissions(String... permissions) {
        // ç‰¹æ®Šæƒ…å†µï¼šè·¨ç§Ÿæˆ·è®¿é—®
        if (skipPermissionCheck()) {
            return true;
        }
        
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
        Long userId = getLoginUserId();
        if (userId == null) {
            return false;
        }
        
        // ä»ç¼“å­˜ä¸­è·å–æƒé™æ ¡éªŒç»“æœ
        return hasAnyPermissionsCache.get(new KeyValue<>(userId, Arrays.asList(permissions)));
    }
    
    @Override
    @SneakyThrows
    public boolean hasAnyRoles(String... roles) {
        // ç‰¹æ®Šæƒ…å†µï¼šè·¨ç§Ÿæˆ·è®¿é—®
        if (skipPermissionCheck()) {
            return true;
        }
        
        // æƒé™æ ¡éªŒ
        Long userId = getLoginUserId();
        if (userId == null) {
            return false;
        }
        
        // ä»ç¼“å­˜ä¸­è·å–è§’è‰²æ ¡éªŒç»“æœ
        return hasAnyRolesCache.get(new KeyValue<>(userId, Arrays.asList(roles)));
    }
}
```

**è®¾è®¡äº®ç‚¹**ï¼š
- âœ… **æœ¬åœ°ç¼“å­˜**ï¼šä½¿ç”¨Guava LoadingCacheç¼“å­˜æƒé™åˆ¤æ–­ç»“æœ
- âœ… **è¿‡æœŸç­–ç•¥**ï¼š1åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸï¼Œå¹³è¡¡æ€§èƒ½ä¸å®æ—¶æ€§
- âœ… **è·¨ç§Ÿæˆ·æ”¯æŒ**ï¼šç‰¹æ®Šåœºæ™¯ä¸‹è·³è¿‡æƒé™æ£€æŸ¥
- âœ… **RPCè°ƒç”¨**ï¼šé€šè¿‡APIè°ƒç”¨æƒé™æœåŠ¡

---

### 3. PermissionService - ç³»ç»Ÿæƒé™æœåŠ¡

#### æ ¸å¿ƒæƒé™åˆ¤æ–­æ–¹æ³•

```java
@Service
@Slf4j
public class PermissionServiceImpl implements PermissionService {
    
    @Resource
    private RoleMenuMapper roleMenuMapper;
    @Resource
    private UserRoleMapper userRoleMapper;
    @Resource
    private RoleService roleService;
    @Resource
    private MenuService menuService;
    
    /**
     * åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰ä»»ä¸€æƒé™
     * 
     * @param userId ç”¨æˆ·ID
     * @param permissions æƒé™æ ‡è¯†æ•°ç»„
     * @return æ˜¯å¦æœ‰æƒé™
     */
    @Override
    public boolean hasAnyPermissions(Long userId, String... permissions) {
        // 1. å¦‚æœä¸ºç©ºï¼Œè¯´æ˜å·²ç»æœ‰æƒé™
        if (ArrayUtil.isEmpty(permissions)) {
            return true;
        }
        
        // 2. è·å¾—å½“å‰ç™»å½•çš„è§’è‰²ï¼ˆå¯ç”¨çŠ¶æ€ï¼‰
        List<RoleDO> roles = getEnableUserRoleListByUserIdFromCache(userId);
        if (CollUtil.isEmpty(roles)) {
            return false;  // æ²¡æœ‰è§’è‰²ï¼Œæ— æƒé™
        }
        
        // 3. éå†åˆ¤æ–­æ¯ä¸ªæƒé™ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ»¡è¶³ï¼Œè¯´æ˜æœ‰æƒé™
        for (String permission : permissions) {
            if (hasAnyPermission(roles, permission)) {
                return true;
            }
        }
        
        // 4. å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œä¹Ÿè¯´æ˜æœ‰æƒé™
        return roleService.hasAnySuperAdmin(convertSet(roles, RoleDO::getId));
    }
    
    /**
     * åˆ¤æ–­æŒ‡å®šè§’è‰²ï¼Œæ˜¯å¦æ‹¥æœ‰è¯¥ permission æƒé™
     * 
     * @param roles æŒ‡å®šè§’è‰²æ•°ç»„
     * @param permission æƒé™æ ‡è¯†
     * @return æ˜¯å¦æ‹¥æœ‰
     */
    private boolean hasAnyPermission(List<RoleDO> roles, String permission) {
        // 1. æ ¹æ®æƒé™æ ‡è¯†ï¼Œè·å–èœå•IDåˆ—è¡¨ï¼ˆä»ç¼“å­˜ï¼‰
        List<Long> menuIds = menuService.getMenuIdListByPermissionFromCache(permission);
        
        // 2. ä¸¥æ ¼æ¨¡å¼ï¼šå¦‚æœæƒé™æ‰¾ä¸åˆ°å¯¹åº”çš„Menuï¼Œè®¤ä¸ºæ²¡æœ‰æƒé™
        if (CollUtil.isEmpty(menuIds)) {
            return false;
        }
        
        // 3. åˆ¤æ–­è§’è‰²æ˜¯å¦æ‹¥æœ‰è¿™äº›èœå•
        Set<Long> roleIds = convertSet(roles, RoleDO::getId);
        for (Long menuId : menuIds) {
            // è·å¾—æ‹¥æœ‰è¯¥èœå•çš„è§’è‰²ç¼–å·é›†åˆï¼ˆä»ç¼“å­˜ï¼‰
            Set<Long> menuRoleIds = getSelf().getMenuRoleIdListByMenuIdFromCache(menuId);
            
            // å¦‚æœæœ‰äº¤é›†ï¼Œè¯´æ˜æœ‰æƒé™
            if (CollUtil.containsAny(menuRoleIds, roleIds)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * è·å¾—ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²ï¼Œå¹¶ä¸”è¿™äº›è§’è‰²æ˜¯å¼€å¯çŠ¶æ€çš„
     */
    @VisibleForTesting
    List<RoleDO> getEnableUserRoleListByUserIdFromCache(Long userId) {
        // 1. è·å¾—ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²ç¼–å·ï¼ˆä»ç¼“å­˜ï¼‰
        Set<Long> roleIds = getSelf().getUserRoleIdListByUserIdFromCache(userId);
        
        // 2. è·å¾—è§’è‰²æ•°ç»„ï¼ˆä»ç¼“å­˜ï¼‰
        List<RoleDO> roles = roleService.getRoleListFromCache(roleIds);
        
        // 3. ç§»é™¤è¢«ç¦ç”¨çš„è§’è‰²
        roles.removeIf(role -> !CommonStatusEnum.ENABLE.getStatus().equals(role.getStatus()));
        
        return roles;
    }
}
```

**æƒé™åˆ¤æ–­æµç¨‹**ï¼š

```
1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è§’è‰²
   â†“ æœ‰è§’è‰²
2. éå†æ¯ä¸ªæƒé™æ ‡è¯† (å¦‚: system:user:create)
   â†“
3. æ ¹æ®æƒé™æ ‡è¯†æŸ¥è¯¢å…³è”çš„èœå•IDåˆ—è¡¨
   â†“
4. éå†èœå•ï¼ŒæŸ¥è¯¢æ‹¥æœ‰è¯¥èœå•çš„è§’è‰²IDé›†åˆ
   â†“
5. åˆ¤æ–­ç”¨æˆ·çš„è§’è‰²IDé›†åˆä¸èœå•çš„è§’è‰²IDé›†åˆæ˜¯å¦æœ‰äº¤é›†
   â†“ æœ‰äº¤é›†
6. è¿”å› true (æœ‰æƒé™)
```

---

## ğŸ” æƒé™æ ¡éªŒå…³é”®æ­¥éª¤è¯¦è§£

### æ­¥éª¤1ï¼šç”¨æˆ· â†’ è§’è‰²æ˜ å°„

```sql
-- system_user_role è¡¨
SELECT role_id FROM system_user_role WHERE user_id = 1;
-- ç»“æœ: [1, 2] (ç”¨æˆ·æ‹¥æœ‰è§’è‰²1å’Œè§’è‰²2)
```

**ç¼“å­˜Key**: `USER_ROLE_ID_LIST:{userId}`

```java
@Cacheable(value = RedisKeyConstants.USER_ROLE_ID_LIST, key = "#userId")
public Set<Long> getUserRoleIdListByUserIdFromCache(Long userId) {
    return getUserRoleIdListByUserId(userId);
}
```

---

### æ­¥éª¤2ï¼šæƒé™æ ‡è¯† â†’ èœå•æ˜ å°„

```sql
-- system_menu è¡¨
SELECT id FROM system_menu WHERE permission = 'system:user:create';
-- ç»“æœ: [100] (èœå•ID=100)
```

**ç¼“å­˜Key**: `PERMISSION_MENU_ID_LIST:{permission}`

```java
@Cacheable(value = RedisKeyConstants.PERMISSION_MENU_ID_LIST, key = "#permission")
public List<Long> getMenuIdListByPermissionFromCache(String permission) {
    return convertList(menuMapper.selectListByPermission(permission), MenuDO::getId);
}
```

---

### æ­¥éª¤3ï¼šèœå• â†’ è§’è‰²æ˜ å°„

```sql
-- system_role_menu è¡¨
SELECT role_id FROM system_role_menu WHERE menu_id = 100;
-- ç»“æœ: [1, 3] (è§’è‰²1å’Œè§’è‰²3æ‹¥æœ‰è¯¥èœå•)
```

**ç¼“å­˜Key**: `MENU_ROLE_ID_LIST:{menuId}`

```java
@Cacheable(value = RedisKeyConstants.MENU_ROLE_ID_LIST, key = "#menuId")
public Set<Long> getMenuRoleIdListByMenuIdFromCache(Long menuId) {
    return convertSet(roleMenuMapper.selectListByMenuId(menuId), RoleMenuDO::getRoleId);
}
```

---

### æ­¥éª¤4ï¼šæƒé™åˆ¤æ–­

```java
// ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²: [1, 2]
// èœå•è¦æ±‚çš„è§’è‰²: [1, 3]
// æœ‰äº¤é›† [1]ï¼Œæ‰€ä»¥æœ‰æƒé™ï¼

if (CollUtil.containsAny(menuRoleIds, roleIds)) {
    return true;  // æœ‰æƒé™
}
```

---

## ğŸ“Š æ•°æ®æƒé™å®ç°

é™¤äº†åŠŸèƒ½æƒé™ï¼Œç³»ç»Ÿè¿˜æ”¯æŒ**æ•°æ®æƒé™**ï¼ˆData Permissionï¼‰ï¼Œæ§åˆ¶ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å“ªäº›æ•°æ®ã€‚

### æ•°æ®æƒé™ç±»å‹ï¼ˆDataScopeEnumï¼‰

```java
public enum DataScopeEnum {
    ALL(1),              // å…¨éƒ¨æ•°æ®æƒé™
    DEPT_CUSTOM(2),      // æŒ‡å®šéƒ¨é—¨æ•°æ®æƒé™
    DEPT_ONLY(3),        // ä»…æœ¬éƒ¨é—¨æ•°æ®æƒé™
    DEPT_AND_CHILD(4),   // æœ¬éƒ¨é—¨åŠå­éƒ¨é—¨æ•°æ®æƒé™
    SELF(5);             // ä»…æœ¬äººæ•°æ®æƒé™
}
```

### æ•°æ®æƒé™åˆ¤æ–­é€»è¾‘

```java
@Override
@DataPermission(enable = false)  // å…³é—­æ•°æ®æƒé™ï¼Œé¿å…é€’å½’
public DeptDataPermissionRespDTO getDeptDataPermission(Long userId) {
    // 1. è·å¾—ç”¨æˆ·çš„è§’è‰²
    List<RoleDO> roles = getEnableUserRoleListByUserIdFromCache(userId);
    
    DeptDataPermissionRespDTO result = new DeptDataPermissionRespDTO();
    
    // 2. å¦‚æœè§’è‰²ä¸ºç©ºï¼Œåˆ™åªèƒ½æŸ¥çœ‹è‡ªå·±
    if (CollUtil.isEmpty(roles)) {
        result.setSelf(true);
        return result;
    }
    
    // 3. éå†æ¯ä¸ªè§’è‰²ï¼Œè®¡ç®—æ•°æ®æƒé™
    for (RoleDO role : roles) {
        Integer dataScope = role.getDataScope();
        
        // æƒ…å†µä¸€ï¼šå…¨éƒ¨æ•°æ®
        if (Objects.equals(dataScope, DataScopeEnum.ALL.getScope())) {
            result.setAll(true);
            continue;
        }
        
        // æƒ…å†µäºŒï¼šæŒ‡å®šéƒ¨é—¨æ•°æ®
        if (Objects.equals(dataScope, DataScopeEnum.DEPT_CUSTOM.getScope())) {
            CollUtil.addAll(result.getDeptIds(), role.getDataScopeDeptIds());
            continue;
        }
        
        // æƒ…å†µä¸‰ï¼šä»…æœ¬éƒ¨é—¨æ•°æ®
        if (Objects.equals(dataScope, DataScopeEnum.DEPT_ONLY.getScope())) {
            CollectionUtils.addIfNotNull(result.getDeptIds(), userDeptId.get());
            continue;
        }
        
        // æƒ…å†µå››ï¼šæœ¬éƒ¨é—¨åŠå­éƒ¨é—¨æ•°æ®
        if (Objects.equals(dataScope, DataScopeEnum.DEPT_AND_CHILD.getScope())) {
            CollUtil.addAll(result.getDeptIds(), 
                deptService.getChildDeptIdListFromCache(userDeptId.get()));
            CollUtil.addAll(result.getDeptIds(), userDeptId.get());
            continue;
        }
        
        // æƒ…å†µäº”ï¼šä»…æœ¬äººæ•°æ®
        if (Objects.equals(dataScope, DataScopeEnum.SELF.getScope())) {
            result.setSelf(true);
            continue;
        }
    }
    
    return result;
}
```

**è¿”å›ç»“æœç¤ºä¾‹**ï¼š

```java
DeptDataPermissionRespDTO {
    all: false,              // ä¸æ˜¯å…¨éƒ¨æ•°æ®
    self: false,             // ä¸ä»…é™æœ¬äºº
    deptIds: [10, 20, 30]    // å¯æŸ¥çœ‹éƒ¨é—¨10ã€20ã€30çš„æ•°æ®
}
```

---

## ğŸ’¾ ç¼“å­˜æœºåˆ¶

### ä¸‰çº§ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 1: Guavaæœ¬åœ°ç¼“å­˜ (1åˆ†é’Ÿ)          â”‚
â”‚  - hasAnyPermissionsCache               â”‚
â”‚  - hasAnyRolesCache                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 2: Redisç¼“å­˜ (é•¿æœŸ)               â”‚
â”‚  - USER_ROLE_ID_LIST:{userId}           â”‚
â”‚  - MENU_ROLE_ID_LIST:{menuId}           â”‚
â”‚  - PERMISSION_MENU_ID_LIST:{permission} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 3: MySQLæ•°æ®åº“                    â”‚
â”‚  - system_user_role                     â”‚
â”‚  - system_role_menu                     â”‚
â”‚  - system_menu                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼“å­˜å¤±æ•ˆç­–ç•¥

#### 1. è§’è‰²èœå•å˜æ›´æ—¶

```java
@Override
@Caching(evict = {
    @CacheEvict(value = RedisKeyConstants.MENU_ROLE_ID_LIST, allEntries = true),
    @CacheEvict(value = RedisKeyConstants.PERMISSION_MENU_ID_LIST, allEntries = true)
})
public void assignRoleMenu(Long roleId, Set<Long> menuIds) {
    // åˆ†é…è§’è‰²èœå•
    // ç¼“å­˜è‡ªåŠ¨å¤±æ•ˆ
}
```

#### 2. ç”¨æˆ·è§’è‰²å˜æ›´æ—¶

```java
@Override
@CacheEvict(value = RedisKeyConstants.USER_ROLE_ID_LIST, key = "#userId")
public void assignUserRole(Long userId, Set<Long> roleIds) {
    // åˆ†é…ç”¨æˆ·è§’è‰²
    // å¯¹åº”ç”¨æˆ·çš„ç¼“å­˜å¤±æ•ˆ
}
```

#### 3. è§’è‰²åˆ é™¤æ—¶

```java
@Override
@Caching(evict = {
    @CacheEvict(value = RedisKeyConstants.MENU_ROLE_ID_LIST, allEntries = true),
    @CacheEvict(value = RedisKeyConstants.USER_ROLE_ID_LIST, allEntries = true)
})
public void processRoleDeleted(Long roleId) {
    // åˆ é™¤è§’è‰²æ—¶æ¸…ç©ºæ‰€æœ‰ç›¸å…³ç¼“å­˜
}
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šåŸºç¡€æƒé™æ ¡éªŒ

```java
@RestController
@RequestMapping("/system/role")
public class RoleController {
    
    // åˆ›å»ºè§’è‰²éœ€è¦ system:role:create æƒé™
    @PostMapping("/create")
    @PreAuthorize("@ss.hasPermission('system:role:create')")
    public CommonResult<Long> createRole(@Valid @RequestBody RoleSaveReqVO reqVO) {
        return success(roleService.createRole(reqVO, null));
    }
    
    // åˆ é™¤è§’è‰²éœ€è¦ system:role:delete æƒé™
    @DeleteMapping("/delete")
    @PreAuthorize("@ss.hasPermission('system:role:delete')")
    public CommonResult<Boolean> deleteRole(@RequestParam("id") Long id) {
        roleService.deleteRole(id);
        return success(true);
    }
}
```

### ç¤ºä¾‹2ï¼šå¤šæƒé™æ ¡éªŒï¼ˆä»»ä¸€å³å¯ï¼‰

```java
@GetMapping("/export")
@PreAuthorize("@ss.hasAnyPermissions('system:user:export', 'system:user:query')")
public void exportUser() {
    // æ‹¥æœ‰å¯¼å‡ºæˆ–æŸ¥è¯¢æƒé™å³å¯
}
```

### ç¤ºä¾‹3ï¼šè§’è‰²æ ¡éªŒ

```java
@GetMapping("/admin-only")
@PreAuthorize("@ss.hasRole('admin')")  // å¿…é¡»æ˜¯adminè§’è‰²
public CommonResult<String> adminOnly() {
    return success("Admin Only");
}

@GetMapping("/any-role")
@PreAuthorize("@ss.hasAnyRoles('admin', 'manager')")  // adminæˆ–managerè§’è‰²
public CommonResult<String> anyRole() {
    return success("Admin or Manager");
}
```

### ç¤ºä¾‹4ï¼šå¤æ‚æƒé™è¡¨è¾¾å¼

```java
// AND é€»è¾‘
@PreAuthorize("@ss.hasPermission('system:user:create') AND @ss.hasRole('admin')")
public CommonResult<Long> createUserWithRole() {
    // å¿…é¡»åŒæ—¶æ‹¥æœ‰æƒé™å’Œè§’è‰²
}

// OR é€»è¾‘
@PreAuthorize("@ss.hasPermission('system:user:create') OR @ss.hasRole('admin')")
public CommonResult<Long> createUserOrRole() {
    // æ‹¥æœ‰æƒé™æˆ–è§’è‰²ä¹‹ä¸€å³å¯
}
```

---

## ğŸ“‹ æƒé™é…ç½®æµç¨‹

### 1. åœ¨æ•°æ®åº“é…ç½®èœå•

```sql
-- æ’å…¥èœå•è®°å½•
INSERT INTO system_menu (
    name, permission, type, sort, status
) VALUES (
    'åˆ›å»ºç”¨æˆ·', 'system:user:create', 3, 1, 0
);
-- type=3 è¡¨ç¤ºæŒ‰é’®æƒé™
-- permission='system:user:create' æƒé™æ ‡è¯†
```

### 2. å°†èœå•åˆ†é…ç»™è§’è‰²

```sql
-- æ’å…¥è§’è‰²èœå•å…³è”
INSERT INTO system_role_menu (role_id, menu_id) 
VALUES (1, 100);
-- è§’è‰²1æ‹¥æœ‰èœå•100çš„æƒé™
```

### 3. å°†è§’è‰²åˆ†é…ç»™ç”¨æˆ·

```sql
-- æ’å…¥ç”¨æˆ·è§’è‰²å…³è”
INSERT INTO system_user_role (user_id, role_id) 
VALUES (1, 1);
-- ç”¨æˆ·1æ‹¥æœ‰è§’è‰²1
```

### 4. åœ¨Controllerä½¿ç”¨æ³¨è§£

```java
@PreAuthorize("@ss.hasPermission('system:user:create')")
public CommonResult<Long> createUser(...) {
    // ...
}
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

### 1. å¤šçº§ç¼“å­˜

- **Guavaæœ¬åœ°ç¼“å­˜**ï¼š1åˆ†é’Ÿè¿‡æœŸï¼Œé¿å…é¢‘ç¹RPCè°ƒç”¨
- **Redisç¼“å­˜**ï¼šé•¿æœŸç¼“å­˜ï¼Œé¿å…æ•°æ®åº“æŸ¥è¯¢
- **æ‡’åŠ è½½**ï¼šåªåœ¨ç¬¬ä¸€æ¬¡è®¿é—®æ—¶åŠ è½½

### 2. æ‰¹é‡æŸ¥è¯¢

```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šå¾ªç¯æŸ¥è¯¢
for (Long roleId : roleIds) {
    List<RoleMenuDO> list = roleMenuMapper.selectListByRoleId(roleId);
}

// âœ… å¥½çš„åšæ³•ï¼šæ‰¹é‡æŸ¥è¯¢
List<RoleMenuDO> list = roleMenuMapper.selectListByRoleId(roleIds);
```

### 3. ç¼“å­˜é¢„çƒ­

```java
// ç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½å¸¸ç”¨æƒé™
@PostConstruct
public void init() {
    List<MenuDO> menus = menuService.getMenuList();
    // é¢„åŠ è½½åˆ°ç¼“å­˜
}
```

### 4. é¿å…ç¼“å­˜ç©¿é€

```java
// å³ä½¿æŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œä¹Ÿç¼“å­˜èµ·æ¥
@Cacheable(value = "cache", key = "#id")
public List<RoleDO> getRoles(Long id) {
    List<RoleDO> roles = roleMapper.selectListByUserId(id);
    return roles == null ? Collections.emptyList() : roles;
}
```

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. æ•æ„Ÿæ“ä½œå¼ºåˆ¶æƒé™æ ¡éªŒ

```java
// âŒ å±é™©ï¼šåˆ é™¤æ“ä½œæ²¡æœ‰æƒé™æ ¡éªŒ
@DeleteMapping("/delete")
public CommonResult<Boolean> deleteUser(@RequestParam Long id) {
    userService.deleteUser(id);
    return success(true);
}

// âœ… å®‰å…¨ï¼šæ·»åŠ æƒé™æ ¡éªŒ
@DeleteMapping("/delete")
@PreAuthorize("@ss.hasPermission('system:user:delete')")
public CommonResult<Boolean> deleteUser(@RequestParam Long id) {
    userService.deleteUser(id);
    return success(true);
}
```

### 2. è¶…çº§ç®¡ç†å‘˜ç‰¹æ®Šå¤„ç†

```java
// è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
if (roleService.hasAnySuperAdmin(roleIds)) {
    return true;
}
```

### 3. æ•°æ®æƒé™éš”ç¦»

```java
// æŸ¥è¯¢æ—¶è‡ªåŠ¨æ·»åŠ æ•°æ®æƒé™è¿‡æ»¤
@DataPermission  // è‡ªåŠ¨æ ¹æ®ç”¨æˆ·çš„æ•°æ®æƒé™è¿‡æ»¤ç»“æœ
public PageResult<UserDO> getUserPage(UserPageReqVO reqVO) {
    return userMapper.selectPage(reqVO);
}
```

---

## ğŸ“ æ€»ç»“

### æƒé™æ ¡éªŒçš„æ ¸å¿ƒç‰¹ç‚¹

1. **ä¸‰å±‚æ¶æ„**ï¼š
   - Controllerå±‚ï¼š`@PreAuthorize` æ³¨è§£å£°æ˜æƒé™
   - Serviceå±‚ï¼š`SecurityFrameworkService` æƒé™åˆ¤æ–­
   - Dataå±‚ï¼š`PermissionService` å…·ä½“å®ç°

2. **RBACæ¨¡å‹**ï¼š
   - User â†’ Role â†’ Menu
   - ç”¨æˆ·æ‹¥æœ‰è§’è‰²ï¼Œè§’è‰²æ‹¥æœ‰èœå•ï¼Œèœå•å¯¹åº”æƒé™

3. **å¤šçº§ç¼“å­˜**ï¼š
   - Guavaæœ¬åœ°ç¼“å­˜ï¼ˆ1åˆ†é’Ÿï¼‰
   - Redisç¼“å­˜ï¼ˆé•¿æœŸï¼‰
   - MySQLæ•°æ®åº“

4. **æ•°æ®æƒé™**ï¼š
   - æ”¯æŒ5ç§æ•°æ®èŒƒå›´
   - è‡ªåŠ¨SQLè¿‡æ»¤

5. **é«˜æ€§èƒ½**ï¼š
   - ç¼“å­˜å‘½ä¸­ç‡é«˜
   - æ‰¹é‡æŸ¥è¯¢
   - æ‡’åŠ è½½

### å…³é”®ä»£ç ä½ç½®

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ |
|------|---------|
| SecurityFrameworkService | `yudao-framework/yudao-spring-boot-starter-security/core/service/` |
| PermissionService | `yudao-module-system/service/permission/` |
| Controllerç¤ºä¾‹ | `yudao-module-system/controller/admin/user/UserController.java` |
| é…ç½®ç±» | `yudao-spring-boot-starter-security/config/YudaoSecurityAutoConfiguration.java` |

---

**æƒé™æ ¡éªŒæ˜¯ç³»ç»Ÿå®‰å…¨çš„æ ¸å¿ƒï¼Œç†è§£å…¶å®ç°åŸç†å¯¹äºå¼€å‘å®‰å…¨å¯é çš„åº”ç”¨è‡³å…³é‡è¦ï¼** ğŸ”
